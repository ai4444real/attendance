<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Presenze</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 2px dashed #ddd;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f0f7ff;
            padding: 15px 20px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-presente-aula {
            background: #d4edda;
            color: #155724;
        }

        .status-presente-zoom {
            background: #cce5ff;
            color: #004085;
        }

        .status-assente {
            background: #f8d7da;
            color: #721c24;
        }

        .status-uscito {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
        }

        .role-docente {
            background: #28a745;
        }

        .role-tutor {
            background: #17a2b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 250px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .checkbox-group {
            min-width: auto;
            justify-content: flex-end;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-group select:hover {
            border-color: #007bff;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            height: 42px;
        }

        .reset-btn:hover {
            background: #5a6268;
        }

        .attendance-summary {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .attendance-summary.course-info {
            background: linear-gradient(135deg, #06b6d4 0%, #10b981 100%);
        }

        .attendance-summary.visible {
            display: block;
        }

        .attendance-summary h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 600;
        }

        .attendance-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .attendance-summary-item {
            background: rgba(255,255,255,0.15);
            padding: 12px 16px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .attendance-summary-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .attendance-summary-value {
            font-size: 24px;
            font-weight: bold;
        }

        .attendance-summary-value.large {
            font-size: 32px;
        }

        .attendance-summary-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px;
        }

        .attendance-summary-badge.success {
            background: #10b981;
        }

        .attendance-summary-badge.warning {
            background: #f59e0b;
        }

        .attendance-summary-badge.info {
            background: #3b82f6;
        }

        .attendance-badge-sm {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }

        .attendance-badge-sm.success {
            background: #d4edda;
            color: #155724;
        }

        .attendance-badge-sm.warning {
            background: #fff3cd;
            color: #856404;
        }

        /* Calendar Section */
        .calendar-section {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }

        .calendar-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
        }

        .calendar-section p {
            margin: 0 0 15px 0;
            opacity: 0.9;
        }

        .calendar-btn {
            background: white;
            color: #667eea;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .calendar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .calendar-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .calendar-btn.secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .calendar-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
            font-size: 14px;
        }

        .calendar-status.success {
            background: rgba(16,185,129,0.2);
        }

        .calendar-status.error {
            background: rgba(239,68,68,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestione Presenze - Sistema Attendance</h1>

        <!-- Google Calendar Integration -->
        <div class="calendar-section" id="calendarSection">
            <h2>üìÖ Google Calendar Integration</h2>
            <p id="calendarDescription">Connetti il tuo Google Calendar per importare automaticamente gli eventi delle lezioni.</p>
            <div>
                <button class="calendar-btn" id="connectCalendarBtn" onclick="CalendarIntegration.connect()">
                    Connetti Google Calendar
                </button>
                <button class="calendar-btn secondary" id="disconnectCalendarBtn" onclick="CalendarIntegration.disconnect()" style="display: none;">
                    Disconnetti
                </button>
                <button class="calendar-btn secondary" id="listCalendarsBtn" onclick="CalendarIntegration.listCalendars()" style="display: none;">
                    Mostra Calendari
                </button>
                <button class="calendar-btn" id="loadEventsBtn" onclick="CalendarIntegration.loadEvents()" style="display: none;">
                    Carica Eventi
                </button>
            </div>
            <div class="calendar-status" id="calendarStatus" style="display: none;"></div>
        </div>

        <div class="upload-section">
            <input type="file" id="csvFile" class="file-input" accept=".csv">
            <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                Carica File CSV
            </button>
            <span id="fileName" style="margin-left: 15px; color: #666;"></span>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <h3>Record Totali</h3>
                <p id="totalRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Record Validi</h3>
                <p id="validRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Record Vuoti (Rimossi)</h3>
                <p id="emptyRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Corsi Unici</h3>
                <p id="uniqueCourses">0</p>
            </div>
            <div class="stat-card">
                <h3>Studenti Unici</h3>
                <p id="uniqueStudents">0</p>
            </div>
            <div class="stat-card">
                <h3>Docenti Unici</h3>
                <p id="uniqueTeachers">0</p>
            </div>
            <div class="stat-card">
                <h3>Tutor Unici</h3>
                <p id="uniqueTutors">0</p>
            </div>
        </div>

        <div class="attendance-summary" id="attendanceSummary">
            <!-- Populated dynamically when course + student are selected -->
        </div>

        <div class="filters" id="filters" style="display: none;">
            <div class="filter-group">
                <label for="courseFilter">Filtra per Corso:</label>
                <select id="courseFilter">
                    <option value="">Tutti i corsi</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="studentFilter">Filtra per Studente:</label>
                <select id="studentFilter">
                    <option value="">Tutti gli studenti</option>
                </select>
            </div>
            <div class="filter-group checkbox-group">
                <label>
                    <input type="checkbox" id="showAbsentCheckbox">
                    Mostra anche assenti
                </label>
            </div>
            <button class="reset-btn" id="resetFilters">Reset Filtri</button>
        </div>

        <div class="loading" id="loading">
            Caricamento e pulizia dati in corso...
        </div>

        <div id="tableContainer"></div>
    </div>

    <!-- Courses Configuration (optional - if not present, defaults will be used) -->
    <script src="/static/courses-config.js"></script>

    <!-- Google OAuth and Calendar API -->
    <script src="/static/js/oauth-config.js"></script>
    <script src="/static/js/google-auth.js"></script>
    <script src="/static/js/google-calendar-api.js"></script>

    <script>
        'use strict';

        // ============================================================================
        // DATA LAYER - Parsing and data access
        // ============================================================================
        const DataService = {
            /**
             * Parse CSV string into array of objects
             * @param {string} csv - Raw CSV content
             * @returns {Array<Object>} Array of row objects with headers as keys
             */
            parseCSV(csv) {
                if (!csv || typeof csv !== 'string') {
                    throw new Error('Invalid CSV input');
                }

                const lines = csv.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV must contain headers and at least one row');
                }

                const headers = this._parseCSVLine(lines[0]);
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = this._parseCSVLine(line);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index].trim();
                        });
                        data.push(row);
                    }
                }

                return data;
            },

            /**
             * Load courses configuration
             * Checks for COURSES_CONFIG global variable (from courses-config.js)
             * Falls back to default config if not found
             * @returns {Promise<Object>} Courses configuration
             */
            async loadCoursesConfig() {
                // Check if COURSES_CONFIG is defined (from courses-config.js)
                if (typeof COURSES_CONFIG !== 'undefined' && COURSES_CONFIG) {
                    console.log('Courses config loaded from courses-config.js');
                    return COURSES_CONFIG;
                }

                // Fallback to defaults
                console.log('Using default config (courses-config.js not included)');
                return this._getDefaultConfig();
            },

            /**
             * Get default configuration when config file is not available
             * @private
             */
            _getDefaultConfig() {
                return {
                    version: "1.0",
                    courses: {},
                    defaults: {
                        totalLessons: null,
                        attendanceThreshold: 0.8,
                        description: "",
                        active: true
                    }
                };
            },

            /**
             * Parse a single CSV line handling quoted values
             * @private
             */
            _parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);

                return result;
            }
        };

        // ============================================================================
        // BUSINESS LOGIC LAYER - Data transformations and filtering
        // ============================================================================
        const AttendanceService = {
            /**
             * Clean data by removing records with empty check-in status
             * @param {Array<Object>} data - Raw attendance data
             * @returns {Array<Object>} Filtered data
             */
            cleanData(data) {
                return data.filter(row =>
                    row['Check-in status'] && row['Check-in status'].trim() !== ''
                );
            },

            /**
             * Sort data by course, date, and student name
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<Object>} Sorted data (new array, immutable)
             */
            sortData(data) {
                return [...data].sort((a, b) => {
                    // 1. Sort by course
                    const courseCompare = a['Class name'].localeCompare(b['Class name']);
                    if (courseCompare !== 0) return courseCompare;

                    // 2. Sort by date
                    const dateA = new Date(a['Date']);
                    const dateB = new Date(b['Date']);
                    if (dateA - dateB !== 0) return dateA - dateB;

                    // 3. Sort by student (first + last name)
                    const studentA = `${a['First name']} ${a['Last name']}`;
                    const studentB = `${b['First name']} ${b['Last name']}`;
                    return studentA.localeCompare(studentB);
                });
            },

            /**
             * Calculate statistics from raw and clean data
             * @param {Array<Object>} rawData - Original data
             * @param {Array<Object>} cleanData - Cleaned data
             * @returns {Object} Statistics object
             */
            calculateStats(rawData, cleanData) {
                // Get all unique people and count by type
                const allPeople = this.getUniqueStudents(cleanData);
                const students = allPeople.filter(p => p.type === 'student').length;
                const teachers = allPeople.filter(p => p.type === 'teacher').length;
                const tutors = allPeople.filter(p => p.type === 'tutor').length;

                return {
                    total: rawData.length,
                    valid: cleanData.length,
                    empty: rawData.length - cleanData.length,
                    uniqueCourses: this.getUniqueCourses(cleanData).length,
                    uniqueStudents: students,
                    uniqueTeachers: teachers,
                    uniqueTutors: tutors
                };
            },

            /**
             * Get list of unique courses
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<string>} Sorted array of unique course names
             */
            getUniqueCourses(data) {
                return [...new Set(data.map(row => row['Class name']))]
                    .sort((a, b) => a.localeCompare(b));
            },

            /**
             * Extract person type and clean first name from raw first name
             * @param {string} firstName - Raw first name (may contain role indicators)
             * @returns {Object} {type: 'student'|'teacher'|'tutor', cleanFirstName: string}
             * @private
             */
            _extractPersonType(firstName) {
                if (firstName.includes('(DOCENTE)')) {
                    return {
                        type: 'teacher',
                        cleanFirstName: firstName.replace('(DOCENTE)', '').trim()
                    };
                } else if (firstName.includes('(TUTOR)')) {
                    return {
                        type: 'tutor',
                        cleanFirstName: firstName.replace('(TUTOR)', '').trim()
                    };
                } else {
                    return {
                        type: 'student',
                        cleanFirstName: firstName
                    };
                }
            },

            /**
             * Get list of unique students (and staff)
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<Object>} Array of {firstName, lastName, fullName, type, cleanFirstName}
             */
            getUniqueStudents(data) {
                const studentsMap = new Map();

                data.forEach(row => {
                    const key = `${row['First name']}|${row['Last name']}`;
                    if (!studentsMap.has(key)) {
                        const personInfo = this._extractPersonType(row['First name']);
                        studentsMap.set(key, {
                            firstName: row['First name'],
                            lastName: row['Last name'],
                            fullName: `${row['First name']} ${row['Last name']}`,
                            type: personInfo.type,
                            cleanFirstName: personInfo.cleanFirstName
                        });
                    }
                });

                return Array.from(studentsMap.values())
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));
            },

            /**
             * Filter data by course name
             * @param {Array<Object>} data - Attendance data
             * @param {string} courseName - Course name to filter by
             * @returns {Array<Object>} Filtered data
             */
            filterByCourse(data, courseName) {
                return data.filter(row => row['Class name'] === courseName);
            },

            /**
             * Filter data by student
             * @param {Array<Object>} data - Attendance data
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {Array<Object>} Filtered data
             */
            filterByStudent(data, firstName, lastName) {
                return data.filter(row =>
                    row['First name'] === firstName && row['Last name'] === lastName
                );
            },

            /**
             * Group data by course
             * @param {Array<Object>} data - Attendance data
             * @returns {Object} Object with course names as keys
             */
            groupByCourse(data) {
                return data.reduce((acc, row) => {
                    const course = row['Class name'];
                    if (!acc[course]) {
                        acc[course] = [];
                    }
                    acc[course].push(row);
                    return acc;
                }, {});
            },

            /**
             * Group data by student
             * @param {Array<Object>} data - Attendance data
             * @returns {Object} Object with student full names as keys
             */
            groupByStudent(data) {
                return data.reduce((acc, row) => {
                    const studentKey = `${row['First name']} ${row['Last name']}`;
                    if (!acc[studentKey]) {
                        acc[studentKey] = [];
                    }
                    acc[studentKey].push(row);
                    return acc;
                }, {});
            },

            /**
             * Get course configuration with fallback to defaults
             * @param {Object} coursesConfig - Full courses configuration object
             * @param {string} courseName - Course name to look up
             * @returns {Object} Course configuration
             */
            getCourseConfig(coursesConfig, courseName) {
                const courseConfig = coursesConfig.courses[courseName];
                if (courseConfig) {
                    return courseConfig;
                }
                // Return defaults if course not found
                return coursesConfig.defaults || {
                    totalLessons: null,
                    attendanceThreshold: 0.8,
                    description: "",
                    active: true
                };
            },

            /**
             * Calculate attendance statistics for a student in a course
             * @param {Array<Object>} data - Attendance data
             * @param {string} courseName - Course name
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @param {Object} coursesConfig - Courses configuration
             * @returns {Object} Attendance statistics
             */
            calculateStudentAttendance(data, courseName, firstName, lastName, coursesConfig) {
                // Filter data for this student and course
                const studentData = data.filter(row =>
                    row['Class name'] === courseName &&
                    row['First name'] === firstName &&
                    row['Last name'] === lastName
                );

                // Calculate attendance score with weighted values
                const attendedRegular = studentData.reduce((sum, row) => {
                    const status = row['Check-in status'].toLowerCase();

                    if (status.includes('assente')) {
                        return sum + 0;  // Absent = 0
                    } else if (status.includes('uscito')) {
                        return sum + 0.5;  // Left early = 0.5
                    } else {
                        return sum + 1;  // Present = 1
                    }
                }, 0);

                // Total lessons attended (including absent marks)
                const totalRecorded = studentData.length;

                // Get course config
                const courseConfig = this.getCourseConfig(coursesConfig, courseName);
                const totalLessons = courseConfig.totalLessons;
                const threshold = courseConfig.attendanceThreshold;

                // Check for manual adjustments in config
                const adjustments = courseConfig.adjustments || {};
                const studentKey = `${firstName}|${lastName}`;
                const adjustment = adjustments[studentKey] || 0;

                // Apply adjustment to attended count
                const attended = attendedRegular + adjustment;

                // Calculate percentage
                let percentage = null;
                let meetsThreshold = null;

                if (totalLessons && totalLessons > 0) {
                    percentage = (attended / totalLessons) * 100;
                    meetsThreshold = percentage >= (threshold * 100);
                }

                return {
                    attended,
                    attendedRegular,
                    adjustment,
                    totalRecorded,
                    totalLessons,
                    percentage,
                    threshold: threshold * 100,
                    meetsThreshold,
                    canTakeExam: meetsThreshold
                };
            },

            /**
             * Calculate attendance summary for all students in a course
             * @param {Array<Object>} data - Attendance data
             * @param {string} courseName - Course name
             * @param {Object} coursesConfig - Courses configuration
             * @returns {Array<Object>} Array of student attendance summaries
             */
            getCourseAttendanceSummary(data, courseName, coursesConfig) {
                // Filter data for this course
                const courseData = this.filterByCourse(data, courseName);

                // Get unique students in this course
                const students = this.getUniqueStudents(courseData);

                // Calculate stats for each student
                return students.map(student => {
                    const stats = this.calculateStudentAttendance(
                        data,
                        courseName,
                        student.firstName,
                        student.lastName,
                        coursesConfig
                    );

                    return {
                        ...student,
                        ...stats
                    };
                }).sort((a, b) => {
                    // Sort by percentage (descending), then by name
                    if (a.percentage !== null && b.percentage !== null) {
                        return b.percentage - a.percentage;
                    }
                    return a.fullName.localeCompare(b.fullName);
                });
            }
        };

        // ============================================================================
        // PRESENTATION LAYER - UI rendering and formatting
        // ============================================================================
        const UIService = {
            /**
             * Display attendance data in table format
             * @param {Array<Object>} data - Attendance data to display
             */
            displayTable(data) {
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Corso</th>
                                <th>Data</th>
                                <th>Studente</th>
                                <th>Stato Presenza</th>
                                <th>% Presenza</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => {
                                const attendanceInfo = this._formatAttendancePercentage(
                                    row['Class name'],
                                    row['First name'],
                                    row['Last name']
                                );
                                return `
                                    <tr>
                                        <td>${this._escapeHtml(row['Class name'])}</td>
                                        <td>${this.formatDate(row['Date'])}</td>
                                        <td>${this.formatStudent(row['First name'], row['Last name'])}</td>
                                        <td>
                                            <span class="status ${this._getStatusClass(row['Check-in status'])}">
                                                ${this._escapeHtml(row['Check-in status'])}
                                            </span>
                                        </td>
                                        <td>${attendanceInfo}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('tableContainer').innerHTML = html;
            },

            /**
             * Update statistics display
             * @param {Object} stats - Statistics object from AttendanceService.calculateStats
             */
            updateStats(stats) {
                document.getElementById('totalRecords').textContent = stats.total;
                document.getElementById('validRecords').textContent = stats.valid;
                document.getElementById('emptyRecords').textContent = stats.empty;
                document.getElementById('uniqueCourses').textContent = stats.uniqueCourses;
                document.getElementById('uniqueStudents').textContent = stats.uniqueStudents;
                document.getElementById('uniqueTeachers').textContent = stats.uniqueTeachers;
                document.getElementById('uniqueTutors').textContent = stats.uniqueTutors;
                document.getElementById('stats').style.display = 'flex';
            },

            /**
             * Format date for Italian locale
             * @param {string} dateStr - Date string
             * @returns {string} Formatted date (dd/mm/yyyy)
             */
            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            },

            /**
             * Format student name with role badges
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {string} HTML string with formatted student name
             */
            formatStudent(firstName, lastName) {
                // Use shared parsing logic from AttendanceService
                const personInfo = AttendanceService._extractPersonType(firstName);

                let html = '';

                // Add role badge if not a student
                if (personInfo.type === 'teacher') {
                    html += '<span class="role-badge role-docente">DOCENTE</span>';
                } else if (personInfo.type === 'tutor') {
                    html += '<span class="role-badge role-tutor">TUTOR</span>';
                }

                html += `${this._escapeHtml(personInfo.cleanFirstName)} ${this._escapeHtml(lastName)}`;
                return html;
            },

            /**
             * Show loading indicator
             */
            showLoading() {
                document.getElementById('loading').classList.add('active');
            },

            /**
             * Hide loading indicator
             */
            hideLoading() {
                document.getElementById('loading').classList.remove('active');
            },

            /**
             * Clear table content
             */
            clearTable() {
                document.getElementById('tableContainer').innerHTML = '';
            },

            /**
             * Update file name display
             * @param {string} fileName - Name of uploaded file
             */
            updateFileName(fileName) {
                document.getElementById('fileName').textContent = fileName;
            },

            /**
             * Get CSS class for attendance status
             * @private
             */
            _getStatusClass(status) {
                const statusLower = status.toLowerCase();
                if (statusLower.includes('presente in aula')) return 'status-presente-aula';
                if (statusLower.includes('presente su zoom')) return 'status-presente-zoom';
                if (statusLower.includes('assente')) return 'status-assente';
                if (statusLower.includes('uscito')) return 'status-uscito';
                return '';
            },

            /**
             * Escape HTML to prevent XSS
             * @private
             */
            _escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * Format attendance percentage for table display
             * @param {string} courseName - Course name
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {string} Formatted HTML for percentage column
             * @private
             */
            _formatAttendancePercentage(courseName, firstName, lastName) {
                const stats = App._getAttendanceStats(courseName, firstName, lastName);

                if (!stats) {
                    return '<span style="color: #999;">-</span>';
                }

                // Adjustment indicator (if present)
                const adjustmentIcon = stats.adjustment !== 0
                    ? `<span style="margin-left: 4px; font-size: 13px;" title="Con correzione manuale: ${stats.adjustment > 0 ? '+' : ''}${stats.adjustment}">‚öôÔ∏è</span>`
                    : '';

                // For courses with total lessons (fixed courses)
                if (stats.totalLessons && stats.percentage !== null) {
                    const percentageDisplay = stats.percentage.toFixed(1);
                    const badgeClass = stats.canTakeExam ? 'success' : 'warning';
                    const icon = stats.canTakeExam ? '‚úì' : '‚úó';

                    return `
                        <span style="font-weight: 600;">${percentageDisplay}%</span>
                        <span class="attendance-badge-sm ${badgeClass}">${icon}</span>
                        ${adjustmentIcon}
                    `;
                }

                // For open courses (no total lessons)
                const attendedDisplay = stats.attended % 1 === 0
                    ? stats.attended
                    : stats.attended.toFixed(1);

                return `<span style="color: #666;">${attendedDisplay} pres.</span>${adjustmentIcon}`;
            },

            /**
             * Populate course filter dropdown
             * @param {Array<string>} courses - Array of course names
             */
            populateCourseFilter(courses) {
                const select = document.getElementById('courseFilter');
                select.innerHTML = '<option value="">Tutti i corsi</option>';

                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    select.appendChild(option);
                });
            },

            /**
             * Populate student filter dropdown
             * @param {Array<Object>} students - Array of student objects
             */
            populateStudentFilter(students) {
                const select = document.getElementById('studentFilter');
                select.innerHTML = '<option value="">Tutti gli studenti</option>';

                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = `${student.firstName}|${student.lastName}`;
                    option.textContent = student.fullName;
                    select.appendChild(option);
                });
            },

            /**
             * Show filters section
             */
            showFilters() {
                document.getElementById('filters').style.display = 'flex';
            },

            /**
             * Reset filter selections
             */
            resetFilters() {
                document.getElementById('courseFilter').value = '';
                document.getElementById('studentFilter').value = '';
            },

            /**
             * Display attendance summary for student in course
             * @param {Object} stats - Attendance statistics
             * @param {string} studentName - Student full name
             * @param {string} courseName - Course name
             */
            showAttendanceSummary(stats, studentName, courseName) {
                const container = document.getElementById('attendanceSummary');

                // Format attended lessons (show decimals only if needed)
                const attendedDisplay = stats.attended % 1 === 0
                    ? stats.attended
                    : stats.attended.toFixed(1);

                // Format breakdown if adjustment is present
                let breakdownHtml = '';
                if (stats.adjustment !== 0) {
                    const regularDisplay = stats.attendedRegular % 1 === 0
                        ? stats.attendedRegular
                        : stats.attendedRegular.toFixed(1);
                    const adjustmentSign = stats.adjustment > 0 ? '+' : '';
                    breakdownHtml = `
                        <div style="margin-top: 4px; font-size: 12px; opacity: 0.9;">
                            (${regularDisplay} reg. ${adjustmentSign}${stats.adjustment} corr.)
                        </div>
                    `;
                }

                let html = `
                    <h2>${this._escapeHtml(studentName)} - ${this._escapeHtml(courseName)}</h2>
                    <div class="attendance-summary-grid">
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Lezioni Partecipate</div>
                            <div class="attendance-summary-value">${attendedDisplay}</div>
                            ${breakdownHtml}
                        </div>
                `;

                if (stats.totalLessons) {
                    html += `
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Totale Lezioni</div>
                            <div class="attendance-summary-value">${stats.totalLessons}</div>
                        </div>
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Percentuale Presenza</div>
                            <div class="attendance-summary-value large">${stats.percentage.toFixed(1)}%</div>
                        </div>
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Soglia Richiesta</div>
                            <div class="attendance-summary-value">${stats.threshold}%</div>
                            ${stats.canTakeExam
                                ? '<div class="attendance-summary-badge success">Pu√≤ fare esame</div>'
                                : '<div class="attendance-summary-badge warning">Soglia non raggiunta</div>'
                            }
                        </div>
                    `;
                } else {
                    html += `
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Tipo Corso</div>
                            <div class="attendance-summary-value" style="font-size: 16px;">Corso Aperto</div>
                            <div class="attendance-summary-badge info">Partecipazione libera</div>
                        </div>
                    `;
                }

                html += `</div>`;

                container.innerHTML = html;
                container.classList.add('visible');
            },

            /**
             * Hide attendance summary
             */
            hideAttendanceSummary() {
                const container = document.getElementById('attendanceSummary');
                container.classList.remove('visible');
                container.classList.remove('course-info');
                container.innerHTML = '';
            },

            /**
             * Display course summary information
             * @param {Object} courseInfo - Course summary information
             */
            showCourseSummary(courseInfo) {
                const container = document.getElementById('attendanceSummary');

                let html = `
                    <h2>${this._escapeHtml(courseInfo.courseName)}</h2>
                    ${courseInfo.description ? `<p style="margin: 0 0 15px 0; opacity: 0.9;">${this._escapeHtml(courseInfo.description)}</p>` : ''}
                    <div class="attendance-summary-grid">
                `;

                // Lessons held (always show)
                html += `
                    <div class="attendance-summary-item">
                        <div class="attendance-summary-label">Lezioni Svolte</div>
                        <div class="attendance-summary-value">${courseInfo.lessonsHeld}${courseInfo.totalLessons ? `/${courseInfo.totalLessons}` : ''}</div>
                    </div>
                `;

                // Total lessons or open course indicator
                if (courseInfo.totalLessons) {
                    html += `
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Soglia Richiesta</div>
                            <div class="attendance-summary-value">${courseInfo.threshold}%</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Tipo Corso</div>
                            <div class="attendance-summary-value" style="font-size: 18px;">Corso Aperto</div>
                            <div class="attendance-summary-badge info">Partecipazione libera</div>
                        </div>
                    `;
                }

                // Student stats
                html += `
                    <div class="attendance-summary-item">
                        <div class="attendance-summary-label">Studenti Iscritti</div>
                        <div class="attendance-summary-value">${courseInfo.totalStudents}</div>
                    </div>
                `;

                // Students who can take exam (only for courses with totalLessons)
                if (courseInfo.totalLessons) {
                    const percentage = courseInfo.totalStudents > 0
                        ? ((courseInfo.studentsCanTakeExam / courseInfo.totalStudents) * 100).toFixed(0)
                        : 0;

                    html += `
                        <div class="attendance-summary-item">
                            <div class="attendance-summary-label">Possono fare esame</div>
                            <div class="attendance-summary-value">${courseInfo.studentsCanTakeExam}/${courseInfo.totalStudents}</div>
                            <div style="margin-top: 4px; opacity: 0.9;">${percentage}% degli studenti</div>
                        </div>
                    `;
                }

                html += `</div>`;

                container.innerHTML = html;
                container.classList.add('visible', 'course-info');
            }
        };

        // ============================================================================
        // APPLICATION CONTROLLER - Orchestration and event handling
        // ============================================================================
        const App = {
            // Store processed data
            _rawData: null,
            _cleanData: null,
            _coursesConfig: null,
            _attendanceStatsCache: null, // Map for pre-calculated percentages
            _currentFilters: {
                course: '',
                student: '',
                showAbsent: false
            },

            /**
             * Initialize application
             */
            init() {
                this._attachEventListeners();
            },

            /**
             * Attach event listeners
             * @private
             */
            _attachEventListeners() {
                document.getElementById('csvFile').addEventListener('change', (e) => {
                    this._handleFileUpload(e);
                });

                document.getElementById('courseFilter').addEventListener('change', (e) => {
                    this._handleFilterChange('course', e.target.value);
                });

                document.getElementById('studentFilter').addEventListener('change', (e) => {
                    this._handleFilterChange('student', e.target.value);
                });

                document.getElementById('showAbsentCheckbox').addEventListener('change', (e) => {
                    this._currentFilters.showAbsent = e.target.checked;
                    this._applyFilters();
                });

                document.getElementById('resetFilters').addEventListener('click', () => {
                    this._handleResetFilters();
                });
            },

            /**
             * Handle file upload
             * @private
             */
            _handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                UIService.updateFileName(file.name);
                UIService.showLoading();
                UIService.clearTable();

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this._processData(e.target.result);
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Errore nel caricamento del file: ' + error.message);
                        UIService.hideLoading();
                    }
                };
                reader.onerror = () => {
                    alert('Errore nella lettura del file');
                    UIService.hideLoading();
                };
                reader.readAsText(file);
            },

            /**
             * Process CSV data
             * @private
             */
            async _processData(csvContent) {
                // Parse CSV
                this._rawData = DataService.parseCSV(csvContent);

                // Load courses configuration (auto-load if available)
                this._coursesConfig = await DataService.loadCoursesConfig();

                // Clean and sort data
                const cleanedData = AttendanceService.cleanData(this._rawData);
                this._cleanData = AttendanceService.sortData(cleanedData);

                // Pre-calculate all attendance statistics for performance
                this._calculateAllAttendanceStats();

                // Reset filters
                this._currentFilters = { course: '', student: '', showAbsent: false };
                document.getElementById('showAbsentCheckbox').checked = false;

                // Calculate statistics
                const stats = AttendanceService.calculateStats(this._rawData, this._cleanData);

                // Populate filters
                const courses = AttendanceService.getUniqueCourses(this._cleanData);
                const students = AttendanceService.getUniqueStudents(this._cleanData);
                UIService.populateCourseFilter(courses);
                UIService.populateStudentFilter(students);
                UIService.showFilters();

                // Update UI
                UIService.updateStats(stats);
                UIService.hideLoading();

                // Apply filters (including absent filter with default OFF)
                this._applyFilters();
            },

            /**
             * Pre-calculate attendance statistics for all student-course combinations
             * Stores results in _attendanceStatsCache for fast lookup
             * @private
             */
            _calculateAllAttendanceStats() {
                this._attendanceStatsCache = new Map();

                // Get unique combinations of course + student
                const combinations = new Set();
                this._cleanData.forEach(row => {
                    const key = `${row['Class name']}|${row['First name']}|${row['Last name']}`;
                    combinations.add(key);
                });

                // Calculate stats for each combination
                combinations.forEach(key => {
                    const [courseName, firstName, lastName] = key.split('|');
                    const stats = AttendanceService.calculateStudentAttendance(
                        this._cleanData,
                        courseName,
                        firstName,
                        lastName,
                        this._coursesConfig
                    );
                    this._attendanceStatsCache.set(key, stats);
                });

                console.log(`Pre-calculated attendance stats for ${combinations.size} student-course combinations`);
            },

            /**
             * Get attendance stats for a specific student-course combination
             * @param {string} courseName - Course name
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {Object|null} Attendance statistics or null if not found
             */
            _getAttendanceStats(courseName, firstName, lastName) {
                const key = `${courseName}|${firstName}|${lastName}`;
                return this._attendanceStatsCache ? this._attendanceStatsCache.get(key) : null;
            },

            /**
             * Calculate course summary statistics
             * @param {string} courseName - Course name
             * @returns {Object} Course summary with student stats
             * @private
             */
            _getCourseSummary(courseName) {
                if (!this._cleanData || !this._coursesConfig || !this._attendanceStatsCache) {
                    return null;
                }

                // Get course config
                const courseConfig = AttendanceService.getCourseConfig(this._coursesConfig, courseName);

                // Get all students in this course
                const courseData = AttendanceService.filterByCourse(this._cleanData, courseName);
                const students = AttendanceService.getUniqueStudents(courseData);

                // Count unique dates (lessons held)
                const uniqueDates = new Set(courseData.map(row => row['Date'])).size;

                // Count students who can take exam (only for courses with totalLessons)
                let studentsCanTakeExam = 0;
                if (courseConfig.totalLessons) {
                    students.forEach(student => {
                        const stats = this._getAttendanceStats(courseName, student.firstName, student.lastName);
                        if (stats && stats.canTakeExam) {
                            studentsCanTakeExam++;
                        }
                    });
                }

                return {
                    courseName,
                    description: courseConfig.description || '',
                    totalLessons: courseConfig.totalLessons,
                    lessonsHeld: uniqueDates,
                    threshold: courseConfig.attendanceThreshold * 100,
                    totalStudents: students.length,
                    studentsCanTakeExam,
                    active: courseConfig.active
                };
            },

            /**
             * Handle filter change
             * @private
             */
            _handleFilterChange(filterType, value) {
                this._currentFilters[filterType] = value;

                // If course filter changed, update student dropdown (cascading filter)
                if (filterType === 'course') {
                    this._updateStudentFilterOptions();
                    // Reset student filter since list changed
                    this._currentFilters.student = '';
                    document.getElementById('studentFilter').value = '';
                }

                this._applyFilters();
            },

            /**
             * Handle reset filters
             * @private
             */
            _handleResetFilters() {
                this._currentFilters = { course: '', student: '', showAbsent: false };
                UIService.resetFilters();
                document.getElementById('showAbsentCheckbox').checked = false;

                // Repopulate student filter with all students
                const allStudents = AttendanceService.getUniqueStudents(this._cleanData);
                UIService.populateStudentFilter(allStudents);

                // Display all data (without absent if checkbox not checked)
                this._applyFilters();
            },

            /**
             * Update student filter options based on selected course
             * @private
             */
            _updateStudentFilterOptions() {
                let dataForStudents = this._cleanData;

                // If a course is selected, filter data by that course
                if (this._currentFilters.course) {
                    dataForStudents = AttendanceService.filterByCourse(
                        dataForStudents,
                        this._currentFilters.course
                    );
                }

                // Get unique students from the filtered data
                const students = AttendanceService.getUniqueStudents(dataForStudents);
                UIService.populateStudentFilter(students);
            },

            /**
             * Apply current filters to data
             * @private
             */
            _applyFilters() {
                let filteredData = this._cleanData;

                // Filter out absent records if checkbox not checked
                if (!this._currentFilters.showAbsent) {
                    filteredData = filteredData.filter(row => {
                        const status = row['Check-in status'].toLowerCase();
                        return !status.includes('assente');
                    });
                }

                // Apply course filter
                if (this._currentFilters.course) {
                    filteredData = AttendanceService.filterByCourse(
                        filteredData,
                        this._currentFilters.course
                    );
                }

                // Apply student filter
                if (this._currentFilters.student) {
                    const [firstName, lastName] = this._currentFilters.student.split('|');
                    filteredData = AttendanceService.filterByStudent(
                        filteredData,
                        firstName,
                        lastName
                    );
                }

                // Show appropriate summary based on filters
                if (this._currentFilters.course && this._currentFilters.student && this._coursesConfig) {
                    // Both course AND student selected ‚Üí Show student attendance
                    const [firstName, lastName] = this._currentFilters.student.split('|');
                    const stats = AttendanceService.calculateStudentAttendance(
                        this._cleanData,
                        this._currentFilters.course,
                        firstName,
                        lastName,
                        this._coursesConfig
                    );
                    const studentName = `${firstName} ${lastName}`;
                    UIService.showAttendanceSummary(stats, studentName, this._currentFilters.course);
                } else if (this._currentFilters.course && !this._currentFilters.student) {
                    // Only course selected ‚Üí Show course summary
                    const courseInfo = this._getCourseSummary(this._currentFilters.course);
                    if (courseInfo) {
                        UIService.showCourseSummary(courseInfo);
                    }
                } else {
                    // No filters or only student ‚Üí Hide summary
                    UIService.hideAttendanceSummary();
                }

                // Update table with filtered data
                UIService.displayTable(filteredData);
            },

            /**
             * Get current clean data
             * @returns {Array<Object>} Current cleaned and sorted data
             */
            getData() {
                return this._cleanData;
            },

            /**
             * Get raw data
             * @returns {Array<Object>} Original raw data
             */
            getRawData() {
                return this._rawData;
            },

            /**
             * Get courses configuration
             * @returns {Object} Courses configuration
             */
            getCoursesConfig() {
                return this._coursesConfig;
            },

            /**
             * Get attendance summary for a specific course
             * @param {string} courseName - Course name
             * @returns {Array<Object>} Student attendance summaries
             */
            getCourseAttendance(courseName) {
                if (!this._cleanData || !this._coursesConfig) {
                    console.warn('Data not loaded yet');
                    return [];
                }
                return AttendanceService.getCourseAttendanceSummary(
                    this._cleanData,
                    courseName,
                    this._coursesConfig
                );
            }
        };

        // ============================================================================
        // CALENDAR INTEGRATION
        // ============================================================================
        const CalendarIntegration = {
            auth: null,
            calendar: null,
            selectedCalendarId: 'primary', // Default to primary calendar

            async init() {
                try {
                    // Load OAuth configuration from backend
                    const config = await loadOAuthConfig();

                    // Initialize OAuth
                    this.auth = new GoogleOAuth(config);
                    this.calendar = new GoogleCalendarAPI(this.auth);

                    // Listen for auth events
                    this.auth.on('authorized', () => {
                        this._updateUI(true);
                    });

                    this.auth.on('unauthorized', () => {
                        this._updateUI(false);
                    });

                    this.auth.on('error', (error) => {
                        this._showStatus(`Errore: ${error.message}`, 'error');
                    });

                    // Update UI based on current auth status
                    this._updateUI(this.auth.isAuthorized());
                } catch (error) {
                    console.error('Failed to initialize Calendar Integration:', error);
                    this._showStatus('Errore caricamento configurazione OAuth', 'error');
                }
            },

            async connect() {
                try {
                    this._showStatus('Connessione in corso...', '');
                    await this.auth.authorize();
                    this._showStatus('‚úÖ Connesso! Puoi caricare gli eventi.', 'success');
                } catch (error) {
                    this._showStatus(`‚ùå Errore: ${error.message}`, 'error');
                }
            },

            async disconnect() {
                try {
                    await this.auth.logout();
                    this._showStatus('Disconnesso', '');
                } catch (error) {
                    this._showStatus(`Errore: ${error.message}`, 'error');
                }
            },

            async listCalendars() {
                try {
                    this._showStatus('Caricamento calendari...', '');

                    const calendars = await this.calendar.listCalendars();

                    console.log('=== CALENDARI DISPONIBILI ===');
                    console.table(calendars.map(cal => ({
                        'Nome': cal.summary,
                        'ID': cal.id,
                        'Primario': cal.primary ? 'S√¨' : 'No',
                        'Accesso': cal.accessRole
                    })));

                    console.log('\nüìã Per selezionare un calendario, copia l\'ID e usa:');
                    console.log('CalendarIntegration.selectCalendar("ID_DEL_CALENDARIO")');
                    console.log('\nOppure per vedere i dettagli completi:');
                    console.log('window.calendars');

                    // Salva in una variabile globale per facile accesso
                    window.calendars = calendars;

                    this._showStatus(
                        `‚úÖ ${calendars.length} calendari trovati! Guarda la console per i dettagli.`,
                        'success'
                    );
                } catch (error) {
                    console.error('Errore nel caricamento dei calendari:', error);
                    this._showStatus(`‚ùå Errore: ${error.message}`, 'error');
                }
            },

            selectCalendar(calendarId) {
                this.selectedCalendarId = calendarId;
                const calendar = window.calendars?.find(c => c.id === calendarId);
                const calendarName = calendar ? calendar.summary : calendarId;

                console.log(`‚úÖ Calendario selezionato: ${calendarName}`);
                this._showStatus(
                    `üìÖ Calendario selezionato: ${calendarName}`,
                    'success'
                );
            },

            async loadEvents() {
                try {
                    this._showStatus('Caricamento eventi in corso...', '');

                    // Get events from last 6 months
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 6);

                    // Use selected calendar (default: 'primary')
                    const calendarName = window.calendars?.find(c => c.id === this.selectedCalendarId)?.summary || this.selectedCalendarId;
                    console.log(`üìÖ Caricamento eventi dal calendario: ${calendarName}`);

                    const lessons = await this.calendar.getLessons(this.selectedCalendarId, startDate, endDate);

                    this._showStatus(
                        `‚úÖ Caricati ${lessons.length} eventi da "${calendarName}"! (Prossima versione: integrazione con attendance)`,
                        'success'
                    );

                    // Log events for debugging
                    console.log('Calendar events loaded:', lessons);

                    // TODO: Future integration with attendance data
                    // For now, just show in console

                } catch (error) {
                    this._showStatus(`‚ùå Errore: ${error.message}`, 'error');
                }
            },

            _updateUI(isAuthorized) {
                const connectBtn = document.getElementById('connectCalendarBtn');
                const disconnectBtn = document.getElementById('disconnectCalendarBtn');
                const listCalendarsBtn = document.getElementById('listCalendarsBtn');
                const loadEventsBtn = document.getElementById('loadEventsBtn');
                const description = document.getElementById('calendarDescription');

                if (isAuthorized) {
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    listCalendarsBtn.style.display = 'inline-block';
                    loadEventsBtn.style.display = 'inline-block';
                    description.textContent = '‚úÖ Connesso al tuo Google Calendar';
                } else {
                    connectBtn.style.display = 'inline-block';
                    disconnectBtn.style.display = 'none';
                    listCalendarsBtn.style.display = 'none';
                    loadEventsBtn.style.display = 'none';
                    description.textContent = 'Connetti il tuo Google Calendar per importare automaticamente gli eventi delle lezioni.';
                }
            },

            _showStatus(message, type) {
                const statusDiv = document.getElementById('calendarStatus');
                statusDiv.textContent = message;
                statusDiv.className = 'calendar-status';
                if (type) statusDiv.classList.add(type);
                statusDiv.style.display = message ? 'block' : 'none';
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
            CalendarIntegration.init();
        });
    </script>
</body>
</html>
