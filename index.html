<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Presenze</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 2px dashed #ddd;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #0056b3;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f0f7ff;
            padding: 15px 20px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-presente-aula {
            background: #d4edda;
            color: #155724;
        }

        .status-presente-zoom {
            background: #cce5ff;
            color: #004085;
        }

        .status-assente {
            background: #f8d7da;
            color: #721c24;
        }

        .status-uscito {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
        }

        .role-docente {
            background: #28a745;
        }

        .role-tutor {
            background: #17a2b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 250px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .checkbox-group {
            min-width: auto;
            justify-content: flex-end;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .filter-group select:hover {
            border-color: #007bff;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            height: 42px;
        }

        .reset-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gestione Presenze - Sistema Attendance</h1>

        <div class="upload-section">
            <input type="file" id="csvFile" class="file-input" accept=".csv">
            <button class="upload-btn" onclick="document.getElementById('csvFile').click()">
                Carica File CSV
            </button>
            <span id="fileName" style="margin-left: 15px; color: #666;"></span>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <h3>Record Totali</h3>
                <p id="totalRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Record Validi</h3>
                <p id="validRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Record Vuoti (Rimossi)</h3>
                <p id="emptyRecords">0</p>
            </div>
            <div class="stat-card">
                <h3>Corsi Unici</h3>
                <p id="uniqueCourses">0</p>
            </div>
            <div class="stat-card">
                <h3>Studenti Unici</h3>
                <p id="uniqueStudents">0</p>
            </div>
        </div>

        <div class="filters" id="filters" style="display: none;">
            <div class="filter-group">
                <label for="courseFilter">Filtra per Corso:</label>
                <select id="courseFilter">
                    <option value="">Tutti i corsi</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="studentFilter">Filtra per Studente:</label>
                <select id="studentFilter">
                    <option value="">Tutti gli studenti</option>
                </select>
            </div>
            <div class="filter-group checkbox-group">
                <label>
                    <input type="checkbox" id="showAbsentCheckbox">
                    Mostra anche assenti
                </label>
            </div>
            <button class="reset-btn" id="resetFilters">Reset Filtri</button>
        </div>

        <div class="loading" id="loading">
            Caricamento e pulizia dati in corso...
        </div>

        <div id="tableContainer"></div>
    </div>

    <script>
        'use strict';

        // ============================================================================
        // DATA LAYER - Parsing and data access
        // ============================================================================
        const DataService = {
            /**
             * Parse CSV string into array of objects
             * @param {string} csv - Raw CSV content
             * @returns {Array<Object>} Array of row objects with headers as keys
             */
            parseCSV(csv) {
                if (!csv || typeof csv !== 'string') {
                    throw new Error('Invalid CSV input');
                }

                const lines = csv.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV must contain headers and at least one row');
                }

                const headers = this._parseCSVLine(lines[0]);
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const values = this._parseCSVLine(line);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index].trim();
                        });
                        data.push(row);
                    }
                }

                return data;
            },

            /**
             * Parse a single CSV line handling quoted values
             * @private
             */
            _parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);

                return result;
            }
        };

        // ============================================================================
        // BUSINESS LOGIC LAYER - Data transformations and filtering
        // ============================================================================
        const AttendanceService = {
            /**
             * Clean data by removing records with empty check-in status
             * @param {Array<Object>} data - Raw attendance data
             * @returns {Array<Object>} Filtered data
             */
            cleanData(data) {
                return data.filter(row =>
                    row['Check-in status'] && row['Check-in status'].trim() !== ''
                );
            },

            /**
             * Sort data by course, date, and student name
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<Object>} Sorted data (new array, immutable)
             */
            sortData(data) {
                return [...data].sort((a, b) => {
                    // 1. Sort by course
                    const courseCompare = a['Class name'].localeCompare(b['Class name']);
                    if (courseCompare !== 0) return courseCompare;

                    // 2. Sort by date
                    const dateA = new Date(a['Date']);
                    const dateB = new Date(b['Date']);
                    if (dateA - dateB !== 0) return dateA - dateB;

                    // 3. Sort by student (first + last name)
                    const studentA = `${a['First name']} ${a['Last name']}`;
                    const studentB = `${b['First name']} ${b['Last name']}`;
                    return studentA.localeCompare(studentB);
                });
            },

            /**
             * Calculate statistics from raw and clean data
             * @param {Array<Object>} rawData - Original data
             * @param {Array<Object>} cleanData - Cleaned data
             * @returns {Object} Statistics object
             */
            calculateStats(rawData, cleanData) {
                return {
                    total: rawData.length,
                    valid: cleanData.length,
                    empty: rawData.length - cleanData.length,
                    uniqueCourses: this.getUniqueCourses(cleanData).length,
                    uniqueStudents: this.getUniqueStudents(cleanData).length
                };
            },

            /**
             * Get list of unique courses
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<string>} Sorted array of unique course names
             */
            getUniqueCourses(data) {
                return [...new Set(data.map(row => row['Class name']))]
                    .sort((a, b) => a.localeCompare(b));
            },

            /**
             * Get list of unique students
             * @param {Array<Object>} data - Attendance data
             * @returns {Array<Object>} Array of {firstName, lastName, fullName}
             */
            getUniqueStudents(data) {
                const studentsMap = new Map();

                data.forEach(row => {
                    const key = `${row['First name']}|${row['Last name']}`;
                    if (!studentsMap.has(key)) {
                        studentsMap.set(key, {
                            firstName: row['First name'],
                            lastName: row['Last name'],
                            fullName: `${row['First name']} ${row['Last name']}`
                        });
                    }
                });

                return Array.from(studentsMap.values())
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));
            },

            /**
             * Filter data by course name
             * @param {Array<Object>} data - Attendance data
             * @param {string} courseName - Course name to filter by
             * @returns {Array<Object>} Filtered data
             */
            filterByCourse(data, courseName) {
                return data.filter(row => row['Class name'] === courseName);
            },

            /**
             * Filter data by student
             * @param {Array<Object>} data - Attendance data
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {Array<Object>} Filtered data
             */
            filterByStudent(data, firstName, lastName) {
                return data.filter(row =>
                    row['First name'] === firstName && row['Last name'] === lastName
                );
            },

            /**
             * Group data by course
             * @param {Array<Object>} data - Attendance data
             * @returns {Object} Object with course names as keys
             */
            groupByCourse(data) {
                return data.reduce((acc, row) => {
                    const course = row['Class name'];
                    if (!acc[course]) {
                        acc[course] = [];
                    }
                    acc[course].push(row);
                    return acc;
                }, {});
            },

            /**
             * Group data by student
             * @param {Array<Object>} data - Attendance data
             * @returns {Object} Object with student full names as keys
             */
            groupByStudent(data) {
                return data.reduce((acc, row) => {
                    const studentKey = `${row['First name']} ${row['Last name']}`;
                    if (!acc[studentKey]) {
                        acc[studentKey] = [];
                    }
                    acc[studentKey].push(row);
                    return acc;
                }, {});
            }
        };

        // ============================================================================
        // PRESENTATION LAYER - UI rendering and formatting
        // ============================================================================
        const UIService = {
            /**
             * Display attendance data in table format
             * @param {Array<Object>} data - Attendance data to display
             */
            displayTable(data) {
                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Corso</th>
                                <th>Data</th>
                                <th>Studente</th>
                                <th>Stato Presenza</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr>
                                    <td>${this._escapeHtml(row['Class name'])}</td>
                                    <td>${this.formatDate(row['Date'])}</td>
                                    <td>${this.formatStudent(row['First name'], row['Last name'])}</td>
                                    <td>
                                        <span class="status ${this._getStatusClass(row['Check-in status'])}">
                                            ${this._escapeHtml(row['Check-in status'])}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('tableContainer').innerHTML = html;
            },

            /**
             * Update statistics display
             * @param {Object} stats - Statistics object from AttendanceService.calculateStats
             */
            updateStats(stats) {
                document.getElementById('totalRecords').textContent = stats.total;
                document.getElementById('validRecords').textContent = stats.valid;
                document.getElementById('emptyRecords').textContent = stats.empty;
                document.getElementById('uniqueCourses').textContent = stats.uniqueCourses;
                document.getElementById('uniqueStudents').textContent = stats.uniqueStudents;
                document.getElementById('stats').style.display = 'flex';
            },

            /**
             * Format date for Italian locale
             * @param {string} dateStr - Date string
             * @returns {string} Formatted date (dd/mm/yyyy)
             */
            formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('it-IT', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            },

            /**
             * Format student name with role badges
             * @param {string} firstName - Student first name
             * @param {string} lastName - Student last name
             * @returns {string} HTML string with formatted student name
             */
            formatStudent(firstName, lastName) {
                let html = '';
                let cleanFirstName = firstName;

                // Check for role indicators
                if (firstName.includes('(DOCENTE)')) {
                    html += '<span class="role-badge role-docente">DOCENTE</span>';
                    cleanFirstName = firstName.replace('(DOCENTE)', '').trim();
                } else if (firstName.includes('(TUTOR)')) {
                    html += '<span class="role-badge role-tutor">TUTOR</span>';
                    cleanFirstName = firstName.replace('(TUTOR)', '').trim();
                }

                html += `${this._escapeHtml(cleanFirstName)} ${this._escapeHtml(lastName)}`;
                return html;
            },

            /**
             * Show loading indicator
             */
            showLoading() {
                document.getElementById('loading').classList.add('active');
            },

            /**
             * Hide loading indicator
             */
            hideLoading() {
                document.getElementById('loading').classList.remove('active');
            },

            /**
             * Clear table content
             */
            clearTable() {
                document.getElementById('tableContainer').innerHTML = '';
            },

            /**
             * Update file name display
             * @param {string} fileName - Name of uploaded file
             */
            updateFileName(fileName) {
                document.getElementById('fileName').textContent = fileName;
            },

            /**
             * Get CSS class for attendance status
             * @private
             */
            _getStatusClass(status) {
                const statusLower = status.toLowerCase();
                if (statusLower.includes('presente in aula')) return 'status-presente-aula';
                if (statusLower.includes('presente su zoom')) return 'status-presente-zoom';
                if (statusLower.includes('assente')) return 'status-assente';
                if (statusLower.includes('uscito')) return 'status-uscito';
                return '';
            },

            /**
             * Escape HTML to prevent XSS
             * @private
             */
            _escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * Populate course filter dropdown
             * @param {Array<string>} courses - Array of course names
             */
            populateCourseFilter(courses) {
                const select = document.getElementById('courseFilter');
                select.innerHTML = '<option value="">Tutti i corsi</option>';

                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    select.appendChild(option);
                });
            },

            /**
             * Populate student filter dropdown
             * @param {Array<Object>} students - Array of student objects
             */
            populateStudentFilter(students) {
                const select = document.getElementById('studentFilter');
                select.innerHTML = '<option value="">Tutti gli studenti</option>';

                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = `${student.firstName}|${student.lastName}`;
                    option.textContent = student.fullName;
                    select.appendChild(option);
                });
            },

            /**
             * Show filters section
             */
            showFilters() {
                document.getElementById('filters').style.display = 'flex';
            },

            /**
             * Reset filter selections
             */
            resetFilters() {
                document.getElementById('courseFilter').value = '';
                document.getElementById('studentFilter').value = '';
            }
        };

        // ============================================================================
        // APPLICATION CONTROLLER - Orchestration and event handling
        // ============================================================================
        const App = {
            // Store processed data
            _rawData: null,
            _cleanData: null,
            _currentFilters: {
                course: '',
                student: '',
                showAbsent: false
            },

            /**
             * Initialize application
             */
            init() {
                this._attachEventListeners();
            },

            /**
             * Attach event listeners
             * @private
             */
            _attachEventListeners() {
                document.getElementById('csvFile').addEventListener('change', (e) => {
                    this._handleFileUpload(e);
                });

                document.getElementById('courseFilter').addEventListener('change', (e) => {
                    this._handleFilterChange('course', e.target.value);
                });

                document.getElementById('studentFilter').addEventListener('change', (e) => {
                    this._handleFilterChange('student', e.target.value);
                });

                document.getElementById('showAbsentCheckbox').addEventListener('change', (e) => {
                    this._currentFilters.showAbsent = e.target.checked;
                    this._applyFilters();
                });

                document.getElementById('resetFilters').addEventListener('click', () => {
                    this._handleResetFilters();
                });
            },

            /**
             * Handle file upload
             * @private
             */
            _handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                UIService.updateFileName(file.name);
                UIService.showLoading();
                UIService.clearTable();

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this._processData(e.target.result);
                    } catch (error) {
                        console.error('Error processing file:', error);
                        alert('Errore nel caricamento del file: ' + error.message);
                        UIService.hideLoading();
                    }
                };
                reader.onerror = () => {
                    alert('Errore nella lettura del file');
                    UIService.hideLoading();
                };
                reader.readAsText(file);
            },

            /**
             * Process CSV data
             * @private
             */
            _processData(csvContent) {
                // Parse CSV
                this._rawData = DataService.parseCSV(csvContent);

                // Clean and sort data
                const cleanedData = AttendanceService.cleanData(this._rawData);
                this._cleanData = AttendanceService.sortData(cleanedData);

                // Reset filters
                this._currentFilters = { course: '', student: '', showAbsent: false };
                document.getElementById('showAbsentCheckbox').checked = false;

                // Calculate statistics
                const stats = AttendanceService.calculateStats(this._rawData, this._cleanData);

                // Populate filters
                const courses = AttendanceService.getUniqueCourses(this._cleanData);
                const students = AttendanceService.getUniqueStudents(this._cleanData);
                UIService.populateCourseFilter(courses);
                UIService.populateStudentFilter(students);
                UIService.showFilters();

                // Update UI
                UIService.updateStats(stats);
                UIService.hideLoading();

                // Apply filters (including absent filter with default OFF)
                this._applyFilters();
            },

            /**
             * Handle filter change
             * @private
             */
            _handleFilterChange(filterType, value) {
                this._currentFilters[filterType] = value;

                // If course filter changed, update student dropdown (cascading filter)
                if (filterType === 'course') {
                    this._updateStudentFilterOptions();
                    // Reset student filter since list changed
                    this._currentFilters.student = '';
                    document.getElementById('studentFilter').value = '';
                }

                this._applyFilters();
            },

            /**
             * Handle reset filters
             * @private
             */
            _handleResetFilters() {
                this._currentFilters = { course: '', student: '', showAbsent: false };
                UIService.resetFilters();
                document.getElementById('showAbsentCheckbox').checked = false;

                // Repopulate student filter with all students
                const allStudents = AttendanceService.getUniqueStudents(this._cleanData);
                UIService.populateStudentFilter(allStudents);

                // Display all data (without absent if checkbox not checked)
                this._applyFilters();
            },

            /**
             * Update student filter options based on selected course
             * @private
             */
            _updateStudentFilterOptions() {
                let dataForStudents = this._cleanData;

                // If a course is selected, filter data by that course
                if (this._currentFilters.course) {
                    dataForStudents = AttendanceService.filterByCourse(
                        dataForStudents,
                        this._currentFilters.course
                    );
                }

                // Get unique students from the filtered data
                const students = AttendanceService.getUniqueStudents(dataForStudents);
                UIService.populateStudentFilter(students);
            },

            /**
             * Apply current filters to data
             * @private
             */
            _applyFilters() {
                let filteredData = this._cleanData;

                // Filter out absent records if checkbox not checked
                if (!this._currentFilters.showAbsent) {
                    filteredData = filteredData.filter(row => {
                        const status = row['Check-in status'].toLowerCase();
                        return !status.includes('assente');
                    });
                }

                // Apply course filter
                if (this._currentFilters.course) {
                    filteredData = AttendanceService.filterByCourse(
                        filteredData,
                        this._currentFilters.course
                    );
                }

                // Apply student filter
                if (this._currentFilters.student) {
                    const [firstName, lastName] = this._currentFilters.student.split('|');
                    filteredData = AttendanceService.filterByStudent(
                        filteredData,
                        firstName,
                        lastName
                    );
                }

                // Update table with filtered data
                UIService.displayTable(filteredData);
            },

            /**
             * Get current clean data
             * @returns {Array<Object>} Current cleaned and sorted data
             */
            getData() {
                return this._cleanData;
            },

            /**
             * Get raw data
             * @returns {Array<Object>} Original raw data
             */
            getRawData() {
                return this._rawData;
            }
        };

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
